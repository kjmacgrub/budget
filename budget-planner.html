<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Planner - Multi-Month</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;1,9..144,300&family=DM+Sans:wght@400;500;700&family=Vollkorn:wght@600&display=swap" rel="stylesheet">
    <style>
        :root {
            --sage: #8B9D83;
            --cream: #FAF7F2;
            --terracotta: #C87259;
            --charcoal: #2D3436;
            --soft-white: #FEFEFE;
            --accent-gold: #D4AF37;
            --shadow: rgba(45, 52, 54, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, #FFFBF5 100%);
            color: var(--charcoal);
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden;
            -webkit-tap-highlight-color: rgba(139, 157, 131, 0.2);
            -webkit-text-size-adjust: 100%;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header.main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            animation: slideDown 0.6s ease-out;
        }

        .header-title-section {
            text-align: center;
            flex: 1;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: 3.5rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 0.5rem;
            letter-spacing: -1px;
        }

        .subtitle {
            font-size: 1.1rem;
            color: var(--sage);
            font-style: italic;
            font-family: 'Fraunces', serif;
        }

        .current-month-display {
            background: var(--soft-white);
            padding: 1.5rem 2rem 1rem 2rem;
            box-shadow: 0 4px 20px var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            border-radius: 16px;
            margin-bottom: 2rem;
        }

        .header-graphic {
            width: 80px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .left-graphic {
            cursor: help;
        }

        .left-graphic svg,
        .right-graphic svg {
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .month-selector-wrapper {
            position: relative;
            display: inline-block;
            width: auto;
            min-width: 300px;
            flex: 1;
            display: flex;
            justify-content: center;
        }

        .month-display-dropdown {
            font-family: 'Vollkorn', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: #2d7a4f;
            letter-spacing: -0.5px;
            background: transparent;
            border: 2px solid transparent;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 3.5rem 0.5rem 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            position: relative;
        }

        .month-display-dropdown:hover {
            background-color: rgba(139, 157, 131, 0.1);
            border-color: var(--sage);
            transform: translateY(-2px);
        }

        .dropdown-arrow {
            font-size: 1.2rem;
            color: var(--charcoal);
            transition: transform 0.3s ease;
        }

        .month-dropdown-menu.active + .month-display-dropdown .dropdown-arrow {
            transform: rotate(180deg);
        }

        .month-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            width: fit-content;
            min-width: 300px;
            max-width: 400px;
            background: white;
            border: 2px solid var(--sage);
            border-radius: 12px;
            margin-top: 0.5rem;
            max-height: 400px;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            z-index: 1000;
        }

        .month-dropdown-menu.active {
            display: block;
        }

        .month-option {
            padding: 1rem 1.5rem;
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            transition: background 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(139, 157, 131, 0.2);
        }

        .month-option:last-child {
            border-bottom: none;
        }

        .month-option:hover {
            background: rgba(139, 157, 131, 0.1);
        }

        .month-option.selected {
            background: rgba(139, 157, 131, 0.2);
            font-weight: 600;
        }

        .month-option.new-month-option {
            background: white;
            color: var(--charcoal);
            font-weight: 600;
            border-top: 2px solid rgba(139, 157, 131, 0.3);
            border-bottom: none;
            justify-content: center;
        }

        .month-option.new-month-option:hover {
            background: white;
            color: #2d7a4f;
        }

        .month-delete-x {
            opacity: 0;
            background: #d63031;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .month-option:hover .month-delete-x {
            opacity: 1;
        }

        .month-delete-x:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .balance-summary {
            background: var(--soft-white);
            padding: 2rem 3.5rem;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 2rem;
            border-radius: 16px;
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 4rem;
            position: relative;
            overflow: visible;
        }

        #balanceArrowCanvas:hover {
            opacity: 0.8;
        }

        .toggle-arrows {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, 10px);
            display: flex;
            gap: 0;
            z-index: 25;
        }

        .toggle-arrow {
            font-size: 0.9rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            transition: all 0.2s ease;
            user-select: none;
        }

        .toggle-arrow.up-arrow {
            color: #2d7a4f;
        }

        .toggle-arrow.down-arrow {
            color: #c0392b;
        }

        .toggle-arrow:hover {
            transform: scale(1.2);
            opacity: 0.8;
        }

        .balance-flow-arrow {
            position: absolute;
            top: -60px;
            left: 0;
            width: 100%;
            height: calc(100% + 120px);
            pointer-events: none;
            z-index: 10;
            opacity: 0.8;
        }

        .balance-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: center;
            min-width: 0;
            position: relative;
            z-index: 20;
        }

        .balance-column.middle-column {
            flex: 1.4;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: center;
            border-left: 1px solid rgba(139, 157, 131, 0.2);
            border-right: 1px solid rgba(139, 157, 131, 0.2);
            padding: 0 2rem;
            min-width: 0;
            z-index: 5;
        }

        .balance-item-small {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
            align-items: center;
        }

        .balance-summary-label-small {
            font-family: 'Fraunces', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--charcoal);
            cursor: help;
            text-align: center;
        }

        .balance-summary-label-small[title]:hover {
            text-decoration: underline dotted;
        }

        .balance-summary-value-small {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d5016;
        }

        .clickable-balance-value {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            margin: -0.25rem -0.5rem;
        }

        .clickable-balance-value:hover {
            background-color: rgba(139, 157, 131, 0.1);
            color: var(--sage);
        }

        .balance-row {
            display: flex;
            justify-content: space-between;
            gap: 2rem;
            margin-bottom: 1.5rem;
        }

        .balance-row:last-child {
            margin-bottom: 0;
        }

        .balance-row.top-row {
            padding-bottom: 1.5rem;
            border-bottom: 2px solid rgba(139, 157, 131, 0.2);
        }

        .balance-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: flex-start;
        }

        .balance-item .balance-summary-input,
        .balance-item .balance-summary-value {
            align-self: flex-start;
        }

        .balance-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid rgba(139, 157, 131, 0.2);
        }

        .balance-summary-row:last-child {
            border-bottom: none;
        }

        .balance-summary-row.indented {
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .balance-summary-label {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--charcoal);
            text-align: center;
            cursor: help;
        }

        .balance-summary-label[title]:hover {
            text-decoration: underline dotted;
        }

        .balance-summary-row:first-child .balance-summary-label,
        .balance-summary-row:last-child .balance-summary-label {
            font-size: 1.7rem;
        }

        .balance-summary-input {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d5016;
            background: transparent;
            border: none;
            text-align: center;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s ease;
            width: auto;
            max-width: fit-content;
            min-width: 120px;
            display: inline-block;
        }

        .balance-summary-row:first-child .balance-summary-input,
        .balance-summary-row:last-child .balance-summary-value {
            font-size: 1.7rem;
        }

        .balance-summary-input:hover {
            background: rgba(139, 157, 131, 0.1);
        }

        .balance-summary-input:focus {
            outline: none;
            background: rgba(139, 157, 131, 0.15);
            cursor: text;
        }

        .balance-summary-value {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d5016;
        }

        .balance-summary-value.clickable-balance {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
        }

        .balance-summary-value.clickable-balance:hover {
            background: rgba(139, 157, 131, 0.1);
            transform: scale(1.05);
        }

        .balance-summary-value .cents {
            font-size: 0.7em;
            vertical-align: baseline;
            font-weight: 500;
        }

        .balance-summary-value.negative {
            color: #d63031;
        }

        .expand-collapse-control {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 1rem;
            padding-right: 1rem;
        }

        .expand-collapse-btn {
            background: var(--sage);
            color: var(--soft-white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .expand-collapse-btn:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 157, 131, 0.3);
        }

        .month-display-dropdown {
            font-family: 'Vollkorn', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: #2d7a4f;
            letter-spacing: -0.5px;
            background: transparent;
            border: 2px solid transparent;
            cursor: pointer;
            text-align: center;
            padding: 0.5rem 3.5rem 0.5rem 1rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233d3d3d' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.5rem;
        }

        .month-display-dropdown:hover {
            background-color: rgba(139, 157, 131, 0.1);
            border-color: var(--sage);
            transform: translateY(-2px);
        }

        .month-display-dropdown:focus {
            outline: none;
            border-color: var(--sage);
            background-color: rgba(139, 157, 131, 0.05);
        }

        .month-display-text {
            font-family: 'Vollkorn', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: #2d7a4f;
            letter-spacing: -0.5px;
        }

        .controls-bar {
            background: var(--soft-white);
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            border-top: 2px solid var(--cream);
        }

        .controls-bar.bottom-controls {
            margin-top: 2rem;
            margin-bottom: 0;
        }

        .month-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .data-controls {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .month-selector {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .month-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .month-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            background: var(--cream);
            border: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-family: 'DM Sans', sans-serif;
        }

        .month-tab:hover {
            background: var(--sage);
            color: var(--soft-white);
        }

        .month-tab.active {
            background: var(--sage);
            color: var(--soft-white);
            border-color: var(--charcoal);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            font-family: 'DM Sans', sans-serif;
        }

        .new-month-btn {
            background: #d4843e;
            color: var(--soft-white);
            border: none;
        }

        .new-month-btn:hover {
            background: #c67232;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 132, 62, 0.4);
        }

        .back-to-summary-btn {
            background: var(--sage);
            color: var(--soft-white);
            margin-bottom: 1.5rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-to-summary-btn:hover {
            background: #7a8c74;
        }

        .delete-month-btn {
            background: var(--sage);
            color: var(--soft-white);
        }

        .delete-month-btn:hover {
            background: #7a8c74;
        }

        .export-btn {
            background: var(--sage);
            color: var(--soft-white);
        }

        .export-btn:hover {
            background: #7a8c74;
            transform: translateY(-2px);
        }

        .import-btn {
            background: var(--sage);
            color: var(--soft-white);
        }

        .import-btn:hover {
            background: #7a8c74;
        }

        .balance-card {
            background: var(--soft-white);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 8px 32px var(--shadow), 0 2px 8px rgba(139, 157, 131, 0.1);
            margin-bottom: 2.5rem;
            position: relative;
            overflow: hidden;
            animation: scaleIn 0.7s ease-out 0.2s both;
        }

        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .balance-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(90deg, var(--sage) 0%, var(--terracotta) 50%, var(--accent-gold) 100%);
        }

        .balance-header {
            font-family: 'Fraunces', serif;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--sage);
            margin-bottom: 0.5rem;
        }

        .balance-amount {
            font-family: 'Fraunces', serif;
            font-size: 4rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 1rem;
        }

        .balance-formula {
            font-size: 0.95rem;
            color: var(--sage);
            font-style: italic;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .two-column-wrapper {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            max-width: 80%;
            margin-left: auto;
            margin-right: auto;
            margin-bottom: 2rem;
            margin-top: 0;
        }

        /* When income section is hidden, move expense section to second column (right) */
        .income-section[style*="display: none"] ~ .expense-section {
            grid-column: 2;
        }

        /* When expense section is hidden, keep income section in first column (left) */
        .expense-section[style*="display: none"] {
            grid-column: 2;
        }

        .section-card {
            background: var(--soft-white);
            padding: 2rem 3rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            animation: slideUp 0.8s ease-out;
            animation-fill-mode: both;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            max-width: none;
            margin: 0;
        }

        .section-card.income-section {
            background: #E8F5E9;
        }

        .section-card.expense-section {
            background: #F5E6D3;
        }

        .balance-display {
            background: var(--soft-white);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 2rem;
            text-align: center;
        }

        .balance-display-label {
            font-family: 'Fraunces', serif;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--sage);
            margin-bottom: 0.5rem;
        }

        .balance-display-value {
            font-family: 'Fraunces', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--charcoal);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .balance-display-value:hover {
            background: rgba(139, 157, 131, 0.1);
        }

        .balance-display-input-field {
            font-family: 'Fraunces', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--charcoal);
            background: transparent;
            border: none;
            text-align: center;
            width: 100%;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .balance-display-input-field:hover {
            background: rgba(139, 157, 131, 0.1);
        }

        .balance-display-input-field:focus {
            outline: none;
            background: rgba(139, 157, 131, 0.15);
            cursor: text;
        }

        .subsection {
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            padding-left: 2rem;
            border-bottom: 1px solid rgba(139, 157, 131, 0.2);
        }

        .subsection:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .subsection-title {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr auto;
            align-items: center;
            gap: 1rem;
            user-select: none;
            padding-bottom: 0.5rem;
        }

        .subsection-title:hover {
            color: var(--sage);
        }

        .subsection-name {
            justify-self: start;
        }

        .subsection-name-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .subsection-clickable {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            cursor: pointer;
        }

        .subsection-name-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            position: relative;
        }

        .delete-category-x {
            opacity: 0;
            background: #d63031;
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 1.2rem;
            line-height: 1;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .subsection-title:hover .delete-category-x {
            opacity: 1;
        }

        .delete-category-x:hover {
            background: #c0392b;
            transform: scale(1.1);
        }

        .subsection-total {
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            color: var(--sage);
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            text-align: right;
            justify-self: end;
        }

        .subsection-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .subsection-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .subsection .expense-item {
            margin-left: 0;
            display: grid;
            grid-template-columns: 1fr auto minmax(120px, 120px);
            align-items: center;
            column-gap: 1rem;
        }

        #incomeList {
            padding-left: 2rem;
        }

        #incomeList .expense-item {
            margin-left: 0;
            display: grid;
            grid-template-columns: 1fr auto minmax(120px, 120px);
            align-items: center;
            column-gap: 1rem;
        }

        .add-button-small {
            background: var(--sage);
            color: var(--soft-white);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.75rem;
            margin-left: 0;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            display: block;
        }

        .add-item-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            color: var(--sage);
            font-weight: 500;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            transition: all 0.2s ease;
            display: inline-block;
            opacity: 0.6;
        }

        .add-item-text:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(139, 157, 131, 0.1);
        }

        .add-item-button-wrapper {
            text-align: center;
            margin-top: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .add-item-button-wrapper .add-button-small {
            display: inline-block;
            margin: 0;
        }

        .add-button-small:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
        }

        .add-category-wrapper {
            text-align: center;
            margin-top: 1.5rem;
            padding-left: 0;
        }

        .add-category-wrapper .add-button-small {
            display: inline-block;
            margin-left: 0;
        }

        .section-content > .add-button {
            margin-left: 2rem;
        }

        .balance-display-input {
            font-family: 'Fraunces', serif;
            font-size: 2.5rem;
            font-weight: 600;
            color: var(--charcoal);
            background: transparent;
            border: none;
            border-bottom: 2px solid var(--sage);
            text-align: center;
            width: 100%;
            padding: 0.5rem;
            transition: border-color 0.3s ease;
        }

        .balance-display-input:focus {
            outline: none;
            border-bottom-color: var(--terracotta);
        }

        .total-display {
            background: var(--soft-white);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            box-shadow: 0 4px 20px var(--shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .total-display.expense-total {
            background: #E8D4BA;
        }

        .total-display-label {
            font-family: 'Fraunces', serif;
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--charcoal);
        }

        .total-display-value {
            font-family: 'Fraunces', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--terracotta);
        }

        .section-card:nth-child(1) { animation-delay: 0.3s; }
        .section-card:nth-child(2) { animation-delay: 0.4s; }
        .section-card:nth-child(3) { animation-delay: 0.5s; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(139, 157, 131, 0.15);
        }

        .section-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--charcoal);
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--sage);
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .section-title:hover {
            color: var(--sage);
        }

        .section-title::after {
            content: 'â–¼';
            font-size: 1rem;
            color: var(--sage);
            transition: transform 0.3s ease;
            margin-left: 1rem;
            flex-shrink: 0;
        }

        .section-title.collapsed::after {
            transform: rotate(-90deg);
        }

        .section-title-text {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .eye-toggle {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
            transition: all 0.2s ease;
            opacity: 0.6;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .eye-toggle-wrapper {
            display: flex;
            justify-content: center;
            padding: 0.5rem 0 1rem 0;
            margin-bottom: 0.5rem;
        }

        .eye-toggle-centered {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            transition: all 0.2s ease;
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border-radius: 12px;
        }

        .eye-toggle .eye-icon,
        .eye-toggle-centered .toggle-icon {
            color: var(--sage);
            transition: all 0.2s ease;
        }

        .eye-toggle-centered .toggle-text {
            font-family: 'DM Sans', sans-serif;
            font-size: 0.85rem;
            color: var(--sage);
            font-weight: 500;
        }

        /* Default state: zeros are hidden, show "show all" text */
        .eye-toggle-centered .hide-zeros-text {
            display: none;
        }

        .eye-toggle-centered .show-all-text {
            display: block;
        }

        /* Active state: zeros are visible, show "hide zeros" text */
        .eye-toggle-centered.active .hide-zeros-text {
            display: block;
        }

        .eye-toggle-centered.active .show-all-text {
            display: none;
        }

        .eye-toggle:hover,
        .eye-toggle-centered:hover {
            opacity: 1;
            transform: scale(1.1);
            background: rgba(139, 157, 131, 0.1);
        }

        .eye-toggle.active,
        .eye-toggle-centered.active {
            opacity: 1;
        }

        .section-title.collapsed .eye-toggle {
            display: none;
        }

        .add-category-plus {
            background: transparent;
            color: var(--sage);
            border: none;
            font-size: 1.5rem;
            font-weight: 400;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            line-height: 1;
            padding: 0.25rem 0.5rem;
            margin-left: 0.5rem;
            flex-shrink: 0;
            opacity: 0.6;
            border-radius: 8px;
        }

        .section-title.collapsed .add-category-plus {
            display: none;
        }

        .add-category-plus:hover {
            opacity: 1;
            transform: scale(1.2);
            background: rgba(139, 157, 131, 0.1);
        }

        .section-name {
            flex: 1;
        }

        .section-total {
            font-family: 'DM Sans', sans-serif;
            font-size: 1.2rem;
            color: var(--charcoal);
        }

        .section-total .cents,
        .subsection-total .cents {
            font-size: 0.7em;
            vertical-align: baseline;
            font-weight: 500;
        }

        .income-section .section-total,
        .income-section .subsection-total {
            color: #2d5016;
        }

        .expense-section .section-total,
        .expense-section .subsection-total {
            color: #a0522d;
        }

        .section-content {
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.4s ease, opacity 0.3s ease;
            opacity: 1;
        }

        .section-content.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0;
        }

        .expense-item {
            display: grid;
            grid-template-columns: 1fr auto minmax(120px, 120px);
            align-items: center;
            column-gap: 1rem;
            padding: 1rem;
            margin-bottom: 0.5rem;
            background: var(--cream);
            border-radius: 12px;
            transition: all 0.3s ease;
            position: relative;
        }

        .expense-item.hide-zero-item,
        .subsection .expense-item.hide-zero-item {
            display: none !important;
        }

        .expense-item:hover {
            background: rgba(139, 157, 131, 0.1);
        }

        .expense-item:hover .delete-item-btn {
            opacity: 1;
        }

        .delete-item-btn {
            background: #d63031;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.3rem 0.6rem;
            cursor: pointer;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
            justify-self: end;
        }

        .delete-item-btn:hover {
            background: #c0392b;
        }

        .expense-label {
            font-weight: 500;
            color: var(--charcoal);
            text-align: left;
            justify-self: start;
        }

        .editable-label {
            cursor: text;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
            outline: none;
        }

        .editable-label:hover {
            background: rgba(139, 157, 131, 0.15);
        }

        .editable-label:focus {
            background: rgba(139, 157, 131, 0.25);
            outline: 2px solid var(--sage);
        }

        .editable-category {
            cursor: text;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            transition: background 0.2s ease;
            display: inline-block;
            outline: none;
        }

        .editable-category:hover {
            background: rgba(139, 157, 131, 0.15);
        }

        .editable-category:focus {
            background: rgba(139, 157, 131, 0.25);
            outline: 2px solid var(--sage);
        }

        .expense-input {
            width: 120px;
            min-width: 120px;
            max-width: 120px;
            padding: 0.5rem 0.75rem;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 1rem;
            text-align: right;
            font-weight: 600;
            color: var(--charcoal);
            background: var(--soft-white);
            transition: all 0.3s ease;
            font-variant-numeric: tabular-nums;
            box-sizing: border-box;
            margin: 0;
        }

        .expense-date {
            width: 130px;
            min-width: 130px;
            max-width: 150px;
            padding: 0.5rem 0.75rem;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 0.9rem;
            color: var(--charcoal);
            background: var(--soft-white);
            transition: all 0.3s ease;
            box-sizing: border-box;
            margin: 0;
            font-family: inherit;
        }

        .expense-date:hover {
            border-color: rgba(139, 157, 131, 0.3);
        }

        .expense-date:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(139, 157, 131, 0.1);
        }

        /* Hide date input when empty to keep it optional-looking */
        .expense-date::-webkit-calendar-picker-indicator {
            opacity: 0.5;
        }

        .expense-date:hover::-webkit-calendar-picker-indicator {
            opacity: 1;
        }

        /* Hide number input spin buttons */
        .expense-input::-webkit-outer-spin-button,
        .expense-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .expense-input[type=number] {
            -moz-appearance: textfield;
        }

        .expense-input:focus {
            outline: none;
            border-color: var(--sage);
            box-shadow: 0 0 0 3px rgba(139, 157, 131, 0.1);
        }

        .add-button {
            background: var(--sage);
            color: var(--soft-white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }

        .add-button:hover {
            background: var(--terracotta);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(200, 114, 89, 0.3);
        }

        .credit-cards {
            background: #F5E6D3;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px var(--shadow);
            animation: slideUp 0.8s ease-out 0.6s both;
        }

        .summary {
            background: linear-gradient(135deg, var(--sage) 0%, #7A8A74 100%);
            color: var(--soft-white);
            padding: 2.5rem;
            border-radius: 20px;
            margin-top: 2rem;
            animation: slideUp 0.8s ease-out 0.7s both;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .summary-item {
            text-align: center;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-value {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 600;
        }

        .summary-input {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            font-weight: 600;
            background: transparent;
            border: none;
            border-bottom: 2px solid rgba(255,255,255,0.3);
            color: var(--soft-white);
            text-align: center;
            width: 100%;
            padding: 0.25rem;
            transition: border-color 0.3s ease;
        }

        .summary-input:focus {
            outline: none;
            border-bottom-color: var(--soft-white);
        }

        .utils-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }

            h1 {
                font-size: 2rem;
            }

            .subtitle {
                font-size: 0.9rem;
            }

            /* Hide arrows on mobile - use projected balance click instead */
            #balanceArrowCanvas {
                display: none !important;
            }

            .toggle-arrows {
                display: none !important;
            }

            /* Date selector */
            .month-display-dropdown {
                font-size: 1.8rem;
                padding: 0.5rem 2.5rem 0.5rem 0.5rem;
            }

            .month-display-text {
                font-size: 1.8rem;
            }

            .month-dropdown-menu {
                min-width: 280px;
                max-width: 90vw;
            }

            /* Balance Summary - Stack vertically */
            .balance-summary {
                flex-direction: column;
                gap: 1.5rem;
                padding: 1.5rem 1rem;
            }

            .balance-flow-arrow {
                display: none;
            }

            .balance-column {
                width: 100%;
                min-width: auto;
            }

            .balance-column.middle-column {
                border-left: none;
                border-right: none;
                border-top: 1px solid rgba(139, 157, 131, 0.2);
                border-bottom: 1px solid rgba(139, 157, 131, 0.2);
                padding: 1rem 0;
            }

            .balance-summary-label {
                font-size: 1.2rem;
            }

            .balance-summary-label-small {
                font-size: 1rem;
            }

            .balance-summary-value {
                font-size: 1.8rem;
            }

            .balance-summary-value-small {
                font-size: 1.4rem;
            }

            .balance-summary-input {
                font-size: 1.8rem;
            }

            /* Two Column Layout - Stack Income/Expenses */
            .two-column-wrapper {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                max-width: 100%;
            }

            .section-card {
                padding: 1.5rem 1rem;
            }

            .section-title {
                font-size: 1.5rem;
            }

            .section-total {
                font-size: 1.2rem;
            }

            .subsection-title {
                font-size: 1.1rem;
            }

            .subsection-total {
                font-size: 0.95rem;
            }

            /* Expense items - better touch targets */
            .expense-item {
                grid-template-columns: 1fr auto 100px;
                gap: 0.5rem;
                padding: 0.75rem 0;
            }

            .expense-input {
                width: 100px;
                min-width: 100px;
                max-width: 100px;
                font-size: 16px; /* Prevents iOS zoom */
                padding: 0.5rem;
            }

            .expense-date {
                display: none; /* Hide date field on mobile for simplicity */
            }

            .expense-label {
                font-size: 1rem;
            }

            .delete-item-btn {
                width: 28px;
                height: 28px;
                font-size: 1.2rem;
            }

            /* Buttons - bigger touch targets */
            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 1rem;
                min-height: 44px; /* iOS minimum touch target */
            }

            .add-button-small {
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
                min-height: 44px;
            }

            .add-category-plus {
                font-size: 1.8rem;
                padding: 0.5rem;
            }

            /* Controls */
            .controls-bar {
                flex-direction: column;
                gap: 1rem;
            }

            .month-controls, .data-controls {
                width: 100%;
                justify-content: center;
                gap: 0.5rem;
            }

            /* Modal */
            .modal-content {
                width: 90%;
                margin: 1rem;
                padding: 1.5rem;
            }

            .modal-title {
                font-size: 1.3rem;
            }

            /* Date picker input */
            .date-picker-input {
                font-size: 16px; /* Prevents iOS zoom */
            }

            /* Header graphics - hide or shrink on mobile */
            .header-graphic {
                width: 50px;
                height: 40px;
            }

            /* Add expense form */
            .add-expense-form {
                padding-left: 0.5rem;
            }

            .form-group {
                flex-direction: column;
            }

            .form-group input {
                font-size: 16px; /* Prevents iOS zoom */
            }

            /* Month options in dropdown */
            .month-option {
                padding: 1rem;
                font-size: 1rem;
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .utils-grid {
                grid-template-columns: 1fr;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        .add-expense-form {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--cream);
            border-radius: 12px;
        }

        .add-expense-form.active {
            display: block;
            animation: slideDown 0.3s ease-out;
        }

        .form-group {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .form-group input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid var(--sage);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
        }

        .form-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .btn-save {
            background: var(--sage);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-cancel {
            background: var(--charcoal);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(45, 52, 54, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--soft-white);
            padding: 2rem;
            border-radius: 16px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-family: 'Fraunces', serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--charcoal);
        }

        .modal-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--sage);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            margin-bottom: 1rem;
        }

        .date-picker-input {
            font-size: 1.1rem;
            cursor: pointer;
        }

        .date-picker-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
            font-size: 1.2rem;
        }

        .modal-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            font-size: 1.2rem;
            color: var(--sage);
        }

        .info-box {
            background: rgba(139, 157, 131, 0.1);
            border-left: 4px solid var(--sage);
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 8px;
        }

        .info-box p {
            margin: 0.5rem 0;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .hidden-input {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header" style="position: relative;">
            <div class="header-graphic left-graphic" title="Budget Planner v1.59">
                <svg width="80" height="60" viewBox="0 0 80 60">
                    <!-- Sun -->
                    <circle cx="40" cy="20" r="12" fill="#f4d03f" opacity="0.6"/>
                    <!-- Sun rays -->
                    <path d="M40,8 L40,2 M48,12 L52,8 M52,20 L58,20 M48,28 L52,32 M32,12 L28,8 M28,20 L22,20 M32,28 L28,32" stroke="#f4d03f" stroke-width="1.5" opacity="0.5"/>
                    <!-- Mountains - outline only -->
                    <path d="M0,45 L15,28 L30,38 L45,25 L60,35 L75,30 L80,40" 
                          stroke="#6b7d63" stroke-width="2" fill="none" opacity="0.8"/>
                    <path d="M5,50 L18,35 L32,42 L48,30 L63,38 L78,35" 
                          stroke="#8b9d83" stroke-width="1.5" fill="none" opacity="0.6"/>
                    <!-- River -->
                    <path d="M10,60 Q20,52 30,50 T50,48 T70,45" stroke="#7eb3d9" stroke-width="3" fill="none" opacity="0.6"/>
                </svg>
            </div>
            <div class="header-title-section">
                <h1>Budget Planner</h1>
                <p class="subtitle">Your financial forecast</p>
            </div>
            <div class="header-graphic right-graphic">
                <svg width="80" height="60" viewBox="0 0 80 60">
                    <!-- Zen garden circles -->
                    <circle cx="40" cy="30" r="22" fill="none" stroke="#c9b896" stroke-width="1" opacity="0.4"/>
                    <circle cx="40" cy="30" r="18" fill="none" stroke="#c9b896" stroke-width="1" opacity="0.5"/>
                    <circle cx="40" cy="30" r="14" fill="none" stroke="#c9b896" stroke-width="1" opacity="0.6"/>
                    <circle cx="40" cy="30" r="10" fill="none" stroke="#c9b896" stroke-width="1" opacity="0.7"/>
                    <!-- Meditating person -->
                    <circle cx="40" cy="25" r="4" fill="#7a8c74"/>
                    <path d="M40,29 L40,38" stroke="#7a8c74" stroke-width="4"/>
                    <path d="M36,32 Q32,34 30,36" stroke="#7a8c74" stroke-width="2.5"/>
                    <path d="M44,32 Q48,34 50,36" stroke="#7a8c74" stroke-width="2.5"/>
                    <ellipse cx="40" cy="42" rx="8" ry="3" fill="#8b9d83"/>
                    <!-- Zen stones -->
                    <circle cx="60" cy="45" r="3" fill="#a89f8f" opacity="0.6"/>
                    <circle cx="20" cy="48" r="2.5" fill="#a89f8f" opacity="0.6"/>
                </svg>
            </div>
        </header>

        <div class="current-month-display">
            <div class="month-selector-wrapper">
                <div class="month-display-dropdown" onclick="toggleMonthDropdown()">
                    <span id="selectedMonthDisplay">January 8, 2026</span>
                </div>
                <div class="month-dropdown-menu" id="monthDropdownMenu">
                    <!-- Populated dynamically -->
                </div>
            </div>
        </div>

        <div class="balance-summary">
            <!-- Arrow canvas - clickable to toggle panels -->
            <canvas id="balanceArrowCanvas" style="position: absolute; pointer-events: auto; z-index: 20; cursor: pointer;" onclick="toggleBudgetPanels()" title="Click to show/hide both sections"></canvas>
            
            <!-- Small toggle arrows below main arrow -->
            <div class="toggle-arrows">
                <span class="toggle-arrow up-arrow" onclick="showIncomeOnly()" title="Show income only">â–²</span>
                <span class="toggle-arrow down-arrow" onclick="showExpensesOnly()" title="Show expenses only">â–¼</span>
            </div>
            
            <div class="balance-column">
                <span class="balance-summary-label" title="Enter your current balance">Starting Balance</span>
                <input type="text" class="balance-summary-input" id="startingBalanceInput" value="$18,000" onfocus="selectStartingBalance()" onblur="formatAndSaveStartingBalance()" onkeypress="if(event.key==='Enter') this.blur()">
            </div>
            <div class="balance-column">
                <span class="balance-summary-label" title="Starting balance, plus all expected income, less expenses">Projected Balance</span>
                <div class="balance-summary-value clickable-balance" id="endingBalanceDisplay" onclick="toggleBudgetPanels()" title="Click to show/hide details">$0</div>
            </div>
        </div>

        <div id="budgetContent" class="loading" style="display: none;">Loading your budget data...</div>

        <div class="controls-bar bottom-controls">
            <div class="data-controls">
                <button class="btn export-btn" onclick="exportData()">â†“ Export</button>
                <button class="btn import-btn" onclick="document.getElementById('importFile').click()">â†‘ Import</button>
                <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importData(event)">
            </div>
        </div>
    </div>

    <!-- New Date Modal -->
    <div class="modal" id="newDateModal">
        <div class="modal-content">
            <h3 class="modal-title">Create New Date</h3>
            <label for="newDatePicker" style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600;">Select a date:</label>
            <input type="date" id="newDatePicker" class="modal-input date-picker-input">
            <div class="modal-buttons">
                <button class="btn-save" onclick="createNewMonthFromPicker()">Create</button>
                <button class="btn-cancel" onclick="hideNewDateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal" id="infoModal">
        <div class="modal-content">
            <h3 class="modal-title">About Your Data</h3>
            <div class="info-box">
                <p><strong>Automatic Saving:</strong> Your data is automatically saved to your Claude account as you type.</p>
                <p><strong>Export Backups:</strong> Click "Export Backup" to download a JSON file with all your budget data.</p>
                <p><strong>Import Backups:</strong> Click "Import Backup" to restore data from a previously exported file.</p>
                <p><strong>Data Ownership:</strong> Keep regular backups! If you cancel your Claude account, the stored data will no longer be accessible.</p>
            </div>
            <div class="modal-buttons">
                <button class="btn-save" onclick="hideInfoModal()">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        let currentMonth = null;
        let allMonths = [];
        let useStorage = true;

        const defaultBudget = {
            customCategories: {
                income: {
                    displayName: 'Income Items',
                    type: 'income'
                },
                credit: {
                    displayName: 'Credit Cards',
                    type: 'expense'
                },
                monthly: {
                    displayName: 'Recurring Expenses',
                    type: 'expense'
                },
                utils: {
                    displayName: 'Utilities',
                    type: 'expense'
                }
            },
            income: [
                { name: 'Monthly Income', amount: 3750 },
                { name: 'Additional Income', amount: 5587 }
            ],
            credit: [
                { name: 'Chase', amount: 1411.28 },
                { name: 'Amex', amount: 67.42 },
                { name: 'Fidelity', amount: 6339.59 }
            ],
            monthly: [
                { name: 'Cash', amount: 100 },
                { name: 'Coffee', amount: 200 },
                { name: 'Copayments', amount: 40 },
                { name: 'Doctors', amount: 125 },
                { name: 'Food', amount: 1200 },
                { name: 'HOA', amount: 390 },
                { name: 'Personal', amount: 50 },
                { name: 'MTA', amount: 150 },
                { name: 'RC', amount: 100 },
                { name: 'Therapy', amount: 1350 }
            ],
            utils: [
                { name: 'ConEd', amount: 100 },
                { name: 'Fios', amount: 85 },
                { name: 'Nat Grid', amount: 150 }
            ],
            oneTime: [
                { name: 'House Insurance', amount: 1500 }
            ],
            startingBalance: 18000
        };

        async function initApp() {
            // Check if storage is available
            if (typeof window.storage === 'undefined') {
                useStorage = false;
                console.warn('Persistent storage not available, using localStorage');
            }

            try {
                if (useStorage) {
                    try {
                        const result = await window.storage.list('budget:');
                        if (result && result.keys && result.keys.length > 0) {
                            allMonths = result.keys.map(key => key.replace('budget:', ''));
                            allMonths.sort().reverse();
                            currentMonth = allMonths[0];
                        } else {
                            // Check localStorage as fallback
                            loadFromLocalStorage();
                        }
                    } catch (storageError) {
                        console.error('Persistent storage error, falling back to localStorage:', storageError);
                        useStorage = false;
                        loadFromLocalStorage();
                    }
                } else {
                    loadFromLocalStorage();
                }
                
                if (!currentMonth || allMonths.length === 0) {
                    await createInitialMonth();
                }
                
                renderMonthTabs();
                await loadMonth(currentMonth);
                
                // Show info modal on first load
                if (!localStorage.getItem('budgetInfoShown')) {
                    setTimeout(() => {
                        document.getElementById('infoModal').classList.add('active');
                        localStorage.setItem('budgetInfoShown', 'true');
                    }, 1000);
                }
            } catch (error) {
                console.error('Error initializing app:', error);
                useStorage = false;
                loadFromLocalStorage();
                if (!currentMonth) {
                    await createInitialMonth();
                }
                renderMonthTabs();
                await loadMonth(currentMonth);
            }
        }

        function loadFromLocalStorage() {
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('budget:')) {
                    keys.push(key.replace('budget:', ''));
                }
            }
            if (keys.length > 0) {
                allMonths = keys.sort().reverse();
                currentMonth = allMonths[0];
            }
        }

        async function createInitialMonth() {
            const today = new Date();
            const monthName = `${today.getMonth() + 1}.${today.getDate()}.${today.getFullYear().toString().slice(-2)}`;
            
            if (useStorage) {
                try {
                    await window.storage.set(`budget:${monthName}`, JSON.stringify(defaultBudget));
                } catch (error) {
                    console.error('Error creating initial month:', error);
                }
            }
            
            allMonths = [monthName];
            currentMonth = monthName;
        }

        function renderMonthTabs() {
            const menu = document.getElementById('monthDropdownMenu');
            const display = document.getElementById('selectedMonthDisplay');
            
            if (!menu || !display) return;
            
            menu.innerHTML = '';
            
            allMonths.forEach(month => {
                const option = document.createElement('div');
                option.className = `month-option ${month === currentMonth ? 'selected' : ''}`;
                
                const monthText = document.createElement('span');
                monthText.textContent = formatMonthDisplay(month);
                monthText.style.flex = '1';
                monthText.style.cursor = 'pointer';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'month-delete-x';
                deleteBtn.innerHTML = 'Ã—';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteMonth(month);
                };
                
                option.appendChild(monthText);
                option.appendChild(deleteBtn);
                
                // Make the whole option clickable to switch months
                option.onclick = (e) => {
                    if (e.target !== deleteBtn) {
                        selectMonth(month);
                    }
                };
                
                menu.appendChild(option);
            });
            
            // Add "New Date" button at the bottom
            const newMonthBtn = document.createElement('div');
            newMonthBtn.className = 'month-option new-month-option';
            newMonthBtn.textContent = '+ New Date';
            newMonthBtn.onclick = () => {
                toggleMonthDropdown();
                createNewMonth();
            };
            menu.appendChild(newMonthBtn);
            
            // Update the display
            display.textContent = formatMonthDisplay(currentMonth);
        }

        function toggleMonthDropdown() {
            const menu = document.getElementById('monthDropdownMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        async function selectMonth(month) {
            if (month !== currentMonth) {
                currentMonth = month;
                toggleMonthDropdown();
                renderMonthTabs(); // Update the display
                await loadMonth(month);
            } else {
                toggleMonthDropdown(); // Just close if clicking current month
            }
        }

        async function deleteMonth(month) {
            if (allMonths.length === 1) {
                console.warn('Cannot delete the last month');
                return;
            }

            console.log('Deleting month:', formatMonthDisplay(month));
            
            try {
                if (useStorage) {
                    try {
                        await window.storage.delete(`budget:${month}`);
                    } catch (storageError) {
                        console.warn('Failed to delete from persistent storage');
                    }
                }
                
                localStorage.removeItem(`budget:${month}`);
                
                const index = allMonths.indexOf(month);
                allMonths.splice(index, 1);
                
                if (currentMonth === month) {
                    currentMonth = allMonths[0];
                    await loadMonth(currentMonth);
                }
                
                renderMonthTabs();
                console.log('Month deleted successfully');
            } catch (error) {
                console.error('Error deleting month:', error);
            }
        }

        function createNewMonth() {
            const modal = document.getElementById('newDateModal');
            const datePicker = document.getElementById('newDatePicker');
            
            // Set default to today's date
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            datePicker.value = `${year}-${month}-${day}`;
            
            modal.style.display = 'flex';
        }

        function hideNewDateModal() {
            const modal = document.getElementById('newDateModal');
            modal.style.display = 'none';
        }

        async function createNewMonthFromPicker() {
            console.log('createNewMonthFromPicker called');
            const datePicker = document.getElementById('newDatePicker');
            const dateValue = datePicker.value;
            
            console.log('Date picker value:', dateValue);
            
            if (!dateValue) {
                alert('Please select a date');
                return;
            }
            
            // Parse the date input (format: YYYY-MM-DD)
            const [year, month, day] = dateValue.split('-');
            const shortYear = year.slice(-2); // Get last 2 digits
            
            // Create month key in M.D.YY format
            const newMonth = `${parseInt(month)}.${parseInt(day)}.${shortYear}`;
            
            // Check if month already exists
            if (allMonths.includes(newMonth)) {
                alert('This date already exists. Please choose a different date.');
                return;
            }
            
            try {
                // Get current month's data to copy
                let templateData;
                
                if (useStorage) {
                    try {
                        const result = await window.storage.get(`budget:${currentMonth}`);
                        templateData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                    } catch (storageError) {
                        console.warn('Persistent storage failed, using current data');
                        templateData = getCurrentBudgetData();
                    }
                } else {
                    templateData = getCurrentBudgetData();
                }
                
                // Set starting balance to zero for new date
                templateData.startingBalance = 0;
                
                console.log('Creating new date with starting balance:', templateData.startingBalance);
                console.log('Template data:', JSON.stringify(templateData, null, 2));
                
                // Save the copied data to the new month
                if (useStorage) {
                    try {
                        await window.storage.set(`budget:${newMonth}`, JSON.stringify(templateData));
                        console.log('Saved to persistent storage');
                    } catch (storageError) {
                        console.warn('Persistent storage failed for new month');
                    }
                }
                
                // Always save to localStorage as backup
                localStorage.setItem(`budget:${newMonth}`, JSON.stringify(templateData));
                console.log('Saved to localStorage');
                
                // Add the new month
                allMonths.push(newMonth);
                allMonths.sort(); // Keep months sorted
                
                // Switch to the new month and set the global variable
                currentMonth = newMonth;
                window.currentStartingBalance = 0;
                await loadMonth(currentMonth);
                renderMonthTabs();
                
                // Hide the modal
                hideNewDateModal();
            } catch (error) {
                console.error('Error creating new date:', error);
                alert('Error creating new date. Please try again.');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('monthDropdownMenu');
            const displayDropdown = document.querySelector('.month-display-dropdown');
            
            // Close dropdown if clicking outside both the menu and the display button
            if (menu && menu.classList.contains('active')) {
                if (!menu.contains(event.target) && !displayDropdown.contains(event.target)) {
                    menu.classList.remove('active');
                }
            }
            
            // Close modal when clicking outside
            const modal = document.getElementById('newDateModal');
            if (modal && event.target === modal) {
                hideNewDateModal();
            }
        });

        function formatMonthDisplay(monthStr) {
            // Parse M.D.YY format to readable "Month Day, Year"
            const parts = monthStr.split('.');
            if (parts.length === 3) {
                const month = parseInt(parts[0]);
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]) + 2000;
                
                const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                                  'July', 'August', 'September', 'October', 'November', 'December'];
                
                return `${monthNames[month - 1]} ${day}, ${year}`;
            }
            return monthStr;
        }

        function switchMonth() {
            const dropdown = document.getElementById('monthDropdown');
            if (dropdown) {
                const selectedMonth = dropdown.value;
                if (selectedMonth && selectedMonth !== currentMonth) {
                    currentMonth = selectedMonth;
                    loadMonth(currentMonth);
                }
            }
        }

        function updateCurrentMonthDisplay() {
            const displayElement = document.getElementById('currentMonthDisplay');
            if (!displayElement) return;
            
            const formatted = formatMonthName(currentMonth);
            displayElement.textContent = formatted;
        }

        function formatMonthName(monthStr) {
            // Try to parse various date formats
            // Format: M.D.YY or MM.DD.YY or "Month Day, Year" or similar
            
            // First, try to parse as M.D.YY format
            const parts = monthStr.split('.');
            if (parts.length === 3) {
                const month = parseInt(parts[0]);
                const day = parseInt(parts[1]);
                const year = parseInt(parts[2]);
                
                const monthNames = [
                    'January', 'February', 'March', 'April', 'May', 'June',
                    'July', 'August', 'September', 'October', 'November', 'December'
                ];
                
                if (month >= 1 && month <= 12) {
                    const fullYear = year < 100 ? 2000 + year : year;
                    return `${monthNames[month - 1]} ${day}, ${fullYear}`;
                }
            }
            
            // If it's already in text format or parsing fails, return as-is
            return monthStr;
        }

        async function loadMonth(month) {
            try {
                let budgetData = defaultBudget;
                
                if (useStorage) {
                    try {
                        const result = await window.storage.get(`budget:${month}`);
                        if (result && result.value) {
                            budgetData = JSON.parse(result.value);
                        }
                    } catch (storageError) {
                        console.warn('Failed to load from persistent storage, checking localStorage');
                        const localData = localStorage.getItem(`budget:${month}`);
                        if (localData) {
                            budgetData = JSON.parse(localData);
                        }
                    }
                } else {
                    // Load from localStorage
                    const localData = localStorage.getItem(`budget:${month}`);
                    if (localData) {
                        budgetData = JSON.parse(localData);
                    }
                }
                
                // Store current starting balance
                window.currentStartingBalance = budgetData.startingBalance !== undefined ? budgetData.startingBalance : 0;
                
                renderBudget(budgetData);
            } catch (error) {
                console.error('Error loading month:', error);
                window.currentStartingBalance = 0;
                renderBudget(defaultBudget);
            }
        }

        function updateStartingBalance(value) {
            window.currentStartingBalance = parseFloat(value) || 0;
            calculateTotals();
            saveBudget();
        }

        function renderBudget(data) {
            // Ensure customCategories exists
            if (!data.customCategories) {
                data.customCategories = {
                    income: { displayName: 'Income Items', type: 'income' },
                    credit: { displayName: 'Credit Cards', type: 'expense' },
                    monthly: { displayName: 'Recurring Expenses', type: 'expense' },
                    utils: { displayName: 'Utilities', type: 'expense' }
                };
            }

            const content = `
                <div class="two-column-wrapper">
                    <!-- Income Section -->
                    <div class="section-card income-section">
                        <h2 class="section-title collapsed" onclick="toggleSection(this)">
                            <span class="section-title-text">
                                Future Income
                            </span>
                            <span class="section-total" id="totalIncome">$0</span>
                            <button class="add-category-plus" onclick="event.stopPropagation(); toggleAddCategoryForm('income')" title="Add Income Category">+</button>
                        </h2>
                        <div class="section-content collapsed">
                            <div class="eye-toggle-wrapper">
                                <button class="eye-toggle-centered" onclick="toggleZeroItems('income')" title="Show/hide zero-value items">
                                    <span class="toggle-text hide-zeros-text">hide zeros</span>
                                    <span class="toggle-text show-all-text">show all</span>
                                </button>
                            </div>
                            ${renderCategoriesByType(data, 'income')}
                            
                            <!-- Add New Income Category Form (hidden by default) -->
                            <div class="add-expense-form" id="addIncomeCategoryForm" style="margin-top: 1rem; padding-left: 2rem;">
                                <div class="form-group">
                                    <input type="text" id="newIncomeCategoryName" placeholder="Category Name (e.g., Freelance, Dividends)">
                                </div>
                                <div class="form-buttons">
                                    <button class="btn-save" onclick="addNewCategory('income')">Create Category</button>
                                    <button class="btn-cancel" onclick="toggleAddCategoryForm('income')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Section -->
                    <div class="section-card expense-section">
                        <h2 class="section-title collapsed" onclick="toggleSection(this)">
                            <span class="section-title-text">
                                Future Expenses
                            </span>
                            <span class="section-total" id="totalExpenses">$0</span>
                            <button class="add-category-plus" onclick="event.stopPropagation(); toggleAddCategoryForm('expense')" title="Add Expense Category">+</button>
                        </h2>
                        <div class="section-content collapsed">
                            <div class="eye-toggle-wrapper">
                                <button class="eye-toggle-centered" onclick="toggleZeroItems('expense')" title="Show/hide zero-value items">
                                    <span class="toggle-text hide-zeros-text">hide zeros</span>
                                    <span class="toggle-text show-all-text">show all</span>
                                </button>
                            </div>
                            ${renderCategoriesByType(data, 'expense')}

                            <!-- Add New Expense Category Form (hidden by default) -->
                            <div class="add-expense-form" id="addExpenseCategoryForm" style="margin-top: 1rem; padding-left: 2rem;">
                                <div class="form-group">
                                    <input type="text" id="newExpenseCategoryName" placeholder="Category Name (e.g., Travel, Entertainment)">
                                </div>
                                <div class="form-buttons">
                                    <button class="btn-save" onclick="addNewCategory('expense')">Create Category</button>
                                    <button class="btn-cancel" onclick="toggleAddCategoryForm('expense')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('budgetContent').innerHTML = content;
            
            document.querySelectorAll('.expense-input').forEach(input => {
                input.addEventListener('input', () => {
                    calculateTotals();
                    saveBudget();
                });
            });
            
            // Update starting balance input field
            const startingBalanceInput = document.getElementById('startingBalanceInput');
            if (startingBalanceInput) {
                const startingBalance = data.startingBalance || 0;
                startingBalanceInput.value = formatCurrencyWhole(startingBalance);
                window.currentStartingBalance = startingBalance;
            }
            
            calculateTotals();
        }

        function renderItems(items, category) {
            // Get the current budget data to check category type
            const budgetData = getCurrentBudgetData();
            const categoryMeta = budgetData.customCategories ? budgetData.customCategories[category] : null;
            
            console.log('renderItems called for category:', category);
            console.log('categoryMeta:', categoryMeta);
            
            // Determine if this is income based on metadata, or fallback to checking category name
            let isIncome = false;
            if (categoryMeta) {
                isIncome = categoryMeta.type === 'income';
                console.log('Using metadata, type:', categoryMeta.type);
            } else {
                // Fallback: check if category key suggests income
                isIncome = category === 'income' || category.toLowerCase().includes('income');
                console.log('No metadata, checking category name. isIncome:', isIncome);
            }
            
            const showZeros = isIncome ? showZeroIncome : showZeroExpense;
            
            console.log('FINAL - category:', category, 'isIncome:', isIncome, 'showZeros:', showZeros, 'showZeroIncome:', showZeroIncome, 'showZeroExpense:', showZeroExpense);
            
            // Don't filter - just mark items as zero or non-zero with CSS class
            // Sort items alphabetically by name
            const sortedItems = [...items].sort((a, b) => a.name.localeCompare(b.name));
            
            return sortedItems.map((item, index) => {
                const amount = parseFloat(item.amount) || 0;
                const isZero = amount === 0;
                const hideClass = (isZero && !showZeros) ? ' hide-zero-item' : '';
                
                if (isZero) {
                    console.log('Zero item:', item.name, 'hideClass:', hideClass);
                }
                
                return `
                <div class="expense-item${hideClass}">
                    <span class="expense-label editable-label" 
                          contenteditable="true" 
                          data-category="${category}" 
                          data-index="${index}"
                          data-item-name="${item.name}"
                          onblur="saveItemName('${category}', ${index}, this)"
                          onkeypress="if(event.key==='Enter') { event.preventDefault(); this.blur(); }"
                          title="Click to edit">${item.name}</span>
                    <button class="delete-item-btn" onclick="deleteItem('${category}', ${index})">Ã—</button>
                    <input type="text" class="expense-input" value="${formatNumberWithCommas(item.amount)}" 
                           data-category="${category}" 
                           data-index="${index}"
                           data-item-name="${item.name}"
                           onfocus="removeCommasOnFocus(this)"
                           onblur="formatAndSaveAmount(this)"
                           onkeypress="if(event.key==='Enter') this.blur()"
                           onmouseover="showAverageTooltip(this, '${category}', '${item.name}')"
                           onmouseout="hideAverageTooltip(this)">
                </div>
            `;
            }).join('');
        }

        function renderCategoriesByType(data, type) {
            if (!data.customCategories) return '';
            
            console.log('renderCategoriesByType called with type:', type);
            console.log('customCategories:', Object.keys(data.customCategories));
            
            let html = '';
            // Sort categories alphabetically by display name
            const sortedCategories = Object.entries(data.customCategories)
                .filter(([key, meta]) => {
                    const matches = meta.type === type && data[key];
                    console.log('Category', key, '- type:', meta.type, 'hasData:', !!data[key], 'matches:', matches);
                    return matches;
                })
                .sort(([, metaA], [, metaB]) => metaA.displayName.localeCompare(metaB.displayName));
            
            console.log('Rendering', sortedCategories.length, 'categories for type:', type);
            
            for (const [key, meta] of sortedCategories) {
                html += `
                    <div class="subsection">
                        <h3 class="subsection-title">
                            <span class="subsection-name-group">
                                <span class="subsection-name editable-category" 
                                      contenteditable="true"
                                      data-category-key="${key}"
                                      onblur="saveCategoryName('${key}', this)"
                                      onkeypress="if(event.key==='Enter') { event.preventDefault(); this.blur(); }"
                                      onclick="event.stopPropagation();"
                                      title="Click to edit">${meta.displayName}</span>
                                <button class="delete-category-x" onclick="event.stopPropagation(); deleteCategory('${key}', '${meta.displayName}')">Ã—</button>
                            </span>
                            <span class="subsection-total" id="total_${key}">$0</span>
                        </h3>
                        <div class="subsection-content">
                            <div id="${key}List">${renderItems(data[key], key)}</div>
                            <div class="add-item-button-wrapper">
                                <span class="add-item-text" onclick="showAddForm('${key}')">New ${meta.displayName}</span>
                            </div>
                            <div class="add-expense-form" id="add_${key}">
                                <div class="form-group">
                                    <input type="text" id="new_${key}_Name" placeholder="Item Name">
                                    <input type="number" id="new_${key}_Amount" placeholder="Amount">
                                </div>
                                <div class="form-buttons">
                                    <button class="btn-save" onclick="addExpense('${key}')">Save</button>
                                    <button class="btn-cancel" onclick="hideAddForm('${key}')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        function renderCustomCategories(data) {
            if (!data.customCategories) return '';
            
            let html = '';
            // Sort categories alphabetically by display name
            const sortedCategories = Object.entries(data.customCategories)
                .filter(([key, meta]) => meta.type === 'expense' && data[key])
                .sort(([, metaA], [, metaB]) => metaA.displayName.localeCompare(metaB.displayName));
            
            for (const [key, meta] of sortedCategories) {
                html += `
                    <div class="subsection">
                        <h3 class="subsection-title collapsed" onclick="toggleSubsection(this)">
                            <span class="subsection-name">${meta.displayName}</span>
                            <span class="subsection-total" id="total_${key}">$0</span>
                        </h3>
                        <div class="subsection-content collapsed">
                            <div id="${key}List">${renderItems(data[key], key)}</div>
                            <div class="add-item-button-wrapper">
                                <button class="add-button-small" onclick="showAddForm('${key}')">+ New ${meta.displayName}</button>
                            </div>
                            <button class="delete-category-btn" onclick="deleteCategory('${key}', '${meta.displayName}')">Delete "${meta.displayName}" Category</button>
                            <div class="add-expense-form" id="add_${key}">
                                <div class="form-group">
                                    <input type="text" id="new_${key}_Name" placeholder="Item Name">
                                    <input type="number" id="new_${key}_Amount" placeholder="Amount">
                                </div>
                                <div class="form-buttons">
                                    <button class="btn-save" onclick="addExpense('${key}')">Save</button>
                                    <button class="btn-cancel" onclick="hideAddForm('${key}')">Cancel</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            return html;
        }

        function selectStartingBalance() {
            const input = document.getElementById('startingBalanceInput');
            if (input) {
                // Remove formatting for editing
                const value = input.value.replace(/[^0-9.]/g, '');
                input.value = value;
                input.select();
            }
        }

        async function deleteCategory(categoryKey, displayName) {
            console.log('Deleting category:', displayName, 'with key:', categoryKey);

            try {
                // Get current budget data
                let budgetData;
                if (useStorage) {
                    try {
                        const result = await window.storage.get(`budget:${currentMonth}`);
                        budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                    } catch (storageError) {
                        const localData = localStorage.getItem(`budget:${currentMonth}`);
                        budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                    }
                } else {
                    const localData = localStorage.getItem(`budget:${currentMonth}`);
                    budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                }

                // Remove the category data
                delete budgetData[categoryKey];
                
                // Remove from custom categories metadata
                if (budgetData.customCategories) {
                    delete budgetData.customCategories[categoryKey];
                }

                console.log('Category deleted, saving...');

                // Save
                if (useStorage) {
                    try {
                        await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                    } catch (error) {
                        console.error('Error saving:', error);
                    }
                }
                localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));

                console.log('Reloading...');
                // Reload
                await loadMonth(currentMonth);
            } catch (error) {
                console.error('Error deleting category:', error);
            }
        }

        function toggleAddCategoryForm(type) {
            const formId = type === 'income' ? 'addIncomeCategoryForm' : 'addExpenseCategoryForm';
            const inputId = type === 'income' ? 'newIncomeCategoryName' : 'newExpenseCategoryName';
            
            // First, make sure the section is expanded
            const sectionClass = type === 'income' ? '.income-section' : '.expense-section';
            const sectionTitle = document.querySelector(`${sectionClass} .section-title`);
            const sectionContent = document.querySelector(`${sectionClass} .section-content`);
            
            if (sectionTitle && sectionContent) {
                // If section is collapsed, expand it
                if (sectionTitle.classList.contains('collapsed')) {
                    sectionTitle.classList.remove('collapsed');
                    sectionContent.classList.remove('collapsed');
                }
            }
            
            const form = document.getElementById(formId);
            if (form) {
                form.classList.toggle('active');
                if (form.classList.contains('active')) {
                    const input = document.getElementById(inputId);
                    if (input) input.focus();
                } else {
                    const input = document.getElementById(inputId);
                    if (input) input.value = '';
                }
            }
        }

        async function addNewCategory(type) {
            console.log('=== ADD NEW CATEGORY START ===');
            console.log('addNewCategory called with type:', type);
            const inputId = type === 'income' ? 'newIncomeCategoryName' : 'newExpenseCategoryName';
            console.log('Looking for input with id:', inputId);
            const nameInput = document.getElementById(inputId);
            console.log('Found input:', nameInput);
            console.log('Input value:', nameInput ? nameInput.value : 'NO INPUT FOUND');
            
            if (!nameInput) {
                console.error('Could not find input element with id:', inputId);
                alert('Error: Could not find input field');
                return;
            }
            
            const categoryName = nameInput.value.trim();
            console.log('Category name entered:', categoryName);
            
            if (!categoryName) {
                console.warn('Please enter a category name');
                alert('Please enter a category name');
                return;
            }
            
            // Get current budget data
            let budgetData;
            console.log('useStorage:', useStorage);
            console.log('currentMonth:', currentMonth);
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    console.log('Storage result:', result);
                    budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                } catch (storageError) {
                    console.error('Storage error:', storageError);
                    budgetData = getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                console.log('LocalStorage data:', localData);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            console.log('Current budget data:', JSON.stringify(budgetData, null, 2));
            
            // Create a key for the new category (sanitize the name)
            const categoryKey = categoryName.toLowerCase().replace(/[^a-z0-9]/g, '_');
            console.log('Category key:', categoryKey);
            
            // Check if category already exists in THIS month's data
            const categoryExistsInData = budgetData[categoryKey] && Array.isArray(budgetData[categoryKey]);
            const categoryExistsInMeta = budgetData.customCategories && budgetData.customCategories[categoryKey];
            
            console.log('Category exists in data array:', categoryExistsInData);
            console.log('Category exists in metadata:', categoryExistsInMeta);
            
            if (categoryExistsInData && categoryExistsInMeta) {
                console.warn('A category with this name already exists!');
                console.warn('Category key that exists:', categoryKey);
                console.warn('All existing category keys:', Object.keys(budgetData.customCategories || {}));
                alert('A category with this name already exists! Try a different name.');
                return;
            }
            
            // Add the new category with an empty array
            budgetData[categoryKey] = [];
            console.log('Added empty array for category:', categoryKey);
            
            // Store the category metadata (for rendering later)
            if (!budgetData.customCategories) {
                budgetData.customCategories = {};
                console.log('Created customCategories object');
            }
            budgetData.customCategories[categoryKey] = {
                displayName: categoryName,
                type: type
            };
            
            console.log('Updated budget data:', JSON.stringify(budgetData, null, 2));
            
            // Save the updated budget
            if (useStorage) {
                try {
                    await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                    console.log('Saved to persistent storage');
                } catch (error) {
                    console.error('Error saving to persistent storage:', error);
                    alert('Error saving category: ' + error.message);
                }
            }
            localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            console.log('Saved to localStorage');
            
            // Clear the input and close form
            nameInput.value = '';
            toggleAddCategoryForm(type);
            
            // Save the current expansion state before reloading
            const incomeSectionTitle = document.querySelector('.income-section .section-title');
            const expenseSectionTitle = document.querySelector('.expense-section .section-title');
            const incomeWasExpanded = incomeSectionTitle && !incomeSectionTitle.classList.contains('collapsed');
            const expenseWasExpanded = expenseSectionTitle && !expenseSectionTitle.classList.contains('collapsed');
            
            console.log('Income was expanded:', incomeWasExpanded);
            console.log('Expense was expanded:', expenseWasExpanded);
            console.log('Reloading month...');
            
            // Reload the budget to show the new category
            await loadMonth(currentMonth);
            
            // Restore the expansion state
            setTimeout(() => {
                if (type === 'income' && incomeWasExpanded) {
                    const incomeTitle = document.querySelector('.income-section .section-title');
                    const incomeContent = document.querySelector('.income-section .section-content');
                    if (incomeTitle && incomeContent) {
                        incomeTitle.classList.remove('collapsed');
                        incomeContent.classList.remove('collapsed');
                    }
                } else if (type === 'expense' && expenseWasExpanded) {
                    const expenseTitle = document.querySelector('.expense-section .section-title');
                    const expenseContent = document.querySelector('.expense-section .section-content');
                    if (expenseTitle && expenseContent) {
                        expenseTitle.classList.remove('collapsed');
                        expenseContent.classList.remove('collapsed');
                    }
                }
                calculateTotals();
                console.log('=== ADD NEW CATEGORY COMPLETE ===');
            }, 50);
        }

        function formatAndSaveStartingBalance() {
            const input = document.getElementById('startingBalanceInput');
            if (input) {
                const cleanValue = input.value.replace(/[^0-9.]/g, '');
                const numValue = parseFloat(cleanValue) || 0;
                
                // Update the value
                window.currentStartingBalance = numValue;
                input.value = formatCurrencyWhole(numValue);
                
                // Recalculate and save
                calculateTotals();
                saveBudget();
            }
        }

        let allExpanded = false;

        function toggleExpandCollapseAll() {
            const button = document.getElementById('expandCollapseBtn');
            
            // Get all section titles and subsection titles
            const sectionTitles = document.querySelectorAll('.section-title');
            const subsectionTitles = document.querySelectorAll('.subsection-title');
            
            if (allExpanded) {
                // Collapse all
                sectionTitles.forEach(title => {
                    const content = title.nextElementSibling;
                    if (content && !title.classList.contains('collapsed')) {
                        title.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }
                });
                subsectionTitles.forEach(title => {
                    const content = title.nextElementSibling;
                    if (content && !title.classList.contains('collapsed')) {
                        title.classList.add('collapsed');
                        content.classList.add('collapsed');
                    }
                });
                button.innerHTML = 'â–¼ Expand All';
                allExpanded = false;
            } else {
                // Expand all
                sectionTitles.forEach(title => {
                    const content = title.nextElementSibling;
                    if (content && title.classList.contains('collapsed')) {
                        title.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                    }
                });
                subsectionTitles.forEach(title => {
                    const content = title.nextElementSibling;
                    if (content && title.classList.contains('collapsed')) {
                        title.classList.remove('collapsed');
                        content.classList.remove('collapsed');
                    }
                });
                button.innerHTML = 'â–² Collapse All';
                allExpanded = true;
            }
        }

        function toggleSection(titleElement) {
            console.log('toggleSection called', titleElement);
            const content = titleElement.nextElementSibling;
            console.log('content element:', content);
            titleElement.classList.toggle('collapsed');
            content.classList.toggle('collapsed');
            console.log('After toggle - title collapsed?', titleElement.classList.contains('collapsed'));
            console.log('After toggle - content collapsed?', content.classList.contains('collapsed'));
        }

        function toggleSubsection(titleElement) {
            const content = titleElement.nextElementSibling;
            if (content) {
                titleElement.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD'
            }).format(value);
        }

        function formatCurrencyWithSuperscriptCents(value) {
            const formatted = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
            
            // Split on decimal point
            const parts = formatted.split('.');
            if (parts.length === 2) {
                return `${parts[0]}<sup class="cents">.${parts[1]}</sup>`;
            }
            return formatted;
        }

        function formatCurrencyWhole(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(Math.trunc(value));
        }

        function formatNumberWithCommas(value) {
            const num = parseFloat(value) || 0;
            return num.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function removeCommasOnFocus(input) {
            const value = input.value.replace(/,/g, '');
            input.value = value;
            input.select();
        }

        function formatAndSaveAmount(input) {
            const category = input.dataset.category;
            const index = parseInt(input.dataset.index);
            const cleanValue = input.value.replace(/,/g, '');
            const numValue = parseFloat(cleanValue) || 0;
            
            // Format with commas
            input.value = formatNumberWithCommas(numValue);
            
            // Save the budget data
            saveBudget();
            calculateTotals();
        }

        function expandIncomeSection() {
            // Hide balance summary
            const balanceSummary = document.querySelector('.balance-summary');
            const budgetContent = document.getElementById('budgetContent');
            
            if (balanceSummary && budgetContent) {
                balanceSummary.style.display = 'none';
                budgetContent.style.display = 'block';
                
                // Scroll to income section and expand it
                const incomeSection = document.querySelector('.section-card.income-section');
                if (incomeSection) {
                    incomeSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Expand income section if collapsed
                    const incomeCollapse = incomeSection.querySelector('.section-collapse');
                    const incomeContent = incomeSection.querySelector('.section-content');
                    if (incomeCollapse && incomeContent) {
                        incomeCollapse.textContent = 'âˆ’';
                        incomeContent.style.display = 'block';
                    }
                }
                
                // Add a "Back to Summary" button at the top of budget content
                let backButton = document.getElementById('backToSummaryBtn');
                if (!backButton) {
                    backButton = document.createElement('button');
                    backButton.id = 'backToSummaryBtn';
                    backButton.className = 'btn back-to-summary-btn';
                    backButton.textContent = 'â† Back to Summary';
                    backButton.onclick = collapseToSummary;
                    budgetContent.insertBefore(backButton, budgetContent.firstChild);
                }
            }
        }

        function expandExpensesSection() {
            // Hide balance summary
            const balanceSummary = document.querySelector('.balance-summary');
            const budgetContent = document.getElementById('budgetContent');
            
            if (balanceSummary && budgetContent) {
                balanceSummary.style.display = 'none';
                budgetContent.style.display = 'block';
                
                // Scroll to expenses section and expand it
                const expensesSection = document.querySelector('.section-card.expenses-section');
                if (expensesSection) {
                    expensesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    
                    // Expand expenses section if collapsed
                    const expensesCollapse = expensesSection.querySelector('.section-collapse');
                    const expensesContent = expensesSection.querySelector('.section-content');
                    if (expensesCollapse && expensesContent) {
                        expensesCollapse.textContent = 'âˆ’';
                        expensesContent.style.display = 'block';
                    }
                }
                
                // Add a "Back to Summary" button at the top of budget content
                let backButton = document.getElementById('backToSummaryBtn');
                if (!backButton) {
                    backButton = document.createElement('button');
                    backButton.id = 'backToSummaryBtn';
                    backButton.className = 'btn back-to-summary-btn';
                    backButton.textContent = 'â† Back to Summary';
                    backButton.onclick = collapseToSummary;
                    budgetContent.insertBefore(backButton, budgetContent.firstChild);
                }
            }
        }

        function collapseToSummary() {
            const balanceSummary = document.querySelector('.balance-summary');
            const budgetContent = document.getElementById('budgetContent');
            const backButton = document.getElementById('backToSummaryBtn');
            
            if (balanceSummary && budgetContent) {
                budgetContent.style.display = 'none';
                balanceSummary.style.display = 'flex';
                
                if (backButton) {
                    backButton.remove();
                }
                
                // Scroll back to balance summary
                balanceSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Track panel visibility state
        let panelsExpanded = false; // Start collapsed - user must click arrow to expand
        let showZeroIncome = false; // Hide zero-value income items by default
        let showZeroExpense = false; // Hide zero-value expense items by default

        function toggleZeroItems(sectionType) {
            console.log('toggleZeroItems called for:', sectionType);
            console.log('Before toggle - showZeroIncome:', showZeroIncome, 'showZeroExpense:', showZeroExpense);
            
            if (sectionType === 'income') {
                showZeroIncome = !showZeroIncome;
            } else {
                showZeroExpense = !showZeroExpense;
            }
            
            console.log('After toggle - showZeroIncome:', showZeroIncome, 'showZeroExpense:', showZeroExpense);
            
            // Store which sections are currently expanded before re-rendering
            const incomeExpanded = !document.querySelector('.income-section .section-title')?.classList.contains('collapsed');
            const expenseExpanded = !document.querySelector('.expense-section .section-title')?.classList.contains('collapsed');
            
            console.log('Section states - incomeExpanded:', incomeExpanded, 'expenseExpanded:', expenseExpanded);
            
            // Re-render to show/hide zero items
            const budgetData = getCurrentBudgetData();
            renderBudget(budgetData);
            
            // Restore expansion state after re-render
            setTimeout(() => {
                const incomeSectionTitle = document.querySelector('.income-section .section-title');
                const incomeSectionContent = document.querySelector('.income-section .section-content');
                const expenseSectionTitle = document.querySelector('.expense-section .section-title');
                const expenseSectionContent = document.querySelector('.expense-section .section-content');
                
                if (incomeExpanded && incomeSectionTitle && incomeSectionContent) {
                    incomeSectionTitle.classList.remove('collapsed');
                    incomeSectionContent.classList.remove('collapsed');
                }
                
                if (expenseExpanded && expenseSectionTitle && expenseSectionContent) {
                    expenseSectionTitle.classList.remove('collapsed');
                    expenseSectionContent.classList.remove('collapsed');
                }
                
                // Update eye button appearance
                const eyeButton = document.querySelector(`.${sectionType}-section .eye-toggle-centered`);
                if (eyeButton) {
                    if ((sectionType === 'income' && showZeroIncome) || (sectionType === 'expense' && showZeroExpense)) {
                        eyeButton.classList.add('active');
                    } else {
                        eyeButton.classList.remove('active');
                    }
                }
            }, 10);
        }

        function toggleBudgetPanels() {
            const budgetContent = document.getElementById('budgetContent');
            
            if (!budgetContent) return;
            
            // Toggle the state
            panelsExpanded = !panelsExpanded;
            
            if (panelsExpanded) {
                // Expand panels - but ensure all sections are COLLAPSED
                budgetContent.style.display = 'block';
                
                // Make sure both sections are visible
                const incomeSection = document.querySelector('.income-section');
                const expenseSection = document.querySelector('.expense-section');
                if (incomeSection) {
                    incomeSection.style.display = 'block';
                }
                if (expenseSection) {
                    expenseSection.style.display = 'block';
                }
                
                // Collapse all income and expense sections using classes
                const incomeSectionContent = document.querySelector('.income-section .section-content');
                const expensesSectionContent = document.querySelector('.expense-section .section-content');
                const incomeSectionTitle = document.querySelector('.income-section .section-title');
                const expensesSectionTitle = document.querySelector('.expense-section .section-title');
                
                if (incomeSectionContent) {
                    incomeSectionContent.classList.add('collapsed');
                }
                if (expensesSectionContent) {
                    expensesSectionContent.classList.add('collapsed');
                }
                if (incomeSectionTitle) {
                    incomeSectionTitle.classList.add('collapsed');
                }
                if (expensesSectionTitle) {
                    expensesSectionTitle.classList.add('collapsed');
                }
                
                // Scroll to budget content
                setTimeout(() => {
                    budgetContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                // Collapse panels - hide everything
                budgetContent.style.display = 'none';
                
                // Scroll back to balance summary
                const balanceSummary = document.querySelector('.balance-summary');
                if (balanceSummary) {
                    balanceSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }
        }

        function showIncomeOnly() {
            const budgetContent = document.getElementById('budgetContent');
            if (!budgetContent) return;
            
            // Get sections
            const incomeSection = document.querySelector('.income-section');
            const expenseSection = document.querySelector('.expense-section');
            
            // Check if income is already the only thing showing
            const incomeVisible = incomeSection && incomeSection.style.display !== 'none';
            const expenseHidden = expenseSection && expenseSection.style.display === 'none';
            const isIncomeOnlyShowing = incomeVisible && expenseHidden && budgetContent.style.display !== 'none';
            
            if (isIncomeOnlyShowing) {
                // Toggle off - hide everything
                budgetContent.style.display = 'none';
                panelsExpanded = false;
                
                // Scroll back to balance
                const balanceSummary = document.querySelector('.balance-summary');
                if (balanceSummary) {
                    balanceSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // Show budget content
                budgetContent.style.display = 'block';
                panelsExpanded = true;
                
                // Show income section, hide expense section
                if (incomeSection) {
                    incomeSection.style.display = 'block';
                }
                if (expenseSection) {
                    expenseSection.style.display = 'none';
                }
                
                // Scroll to budget content
                setTimeout(() => {
                    budgetContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function showExpensesOnly() {
            const budgetContent = document.getElementById('budgetContent');
            if (!budgetContent) return;
            
            // Get sections
            const incomeSection = document.querySelector('.income-section');
            const expenseSection = document.querySelector('.expense-section');
            
            // Check if expenses is already the only thing showing
            const expenseVisible = expenseSection && expenseSection.style.display !== 'none';
            const incomeHidden = incomeSection && incomeSection.style.display === 'none';
            const isExpenseOnlyShowing = expenseVisible && incomeHidden && budgetContent.style.display !== 'none';
            
            if (isExpenseOnlyShowing) {
                // Toggle off - hide everything
                budgetContent.style.display = 'none';
                panelsExpanded = false;
                
                // Scroll back to balance
                const balanceSummary = document.querySelector('.balance-summary');
                if (balanceSummary) {
                    balanceSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            } else {
                // Show budget content
                budgetContent.style.display = 'block';
                panelsExpanded = true;
                
                // Hide income section, show expense section
                if (incomeSection) {
                    incomeSection.style.display = 'none';
                }
                if (expenseSection) {
                    expenseSection.style.display = 'block';
                }
                
                // Scroll to budget content
                setTimeout(() => {
                    budgetContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function drawBalanceArrow() {
            const canvas = document.getElementById('balanceArrowCanvas');
            if (!canvas) return;
            
            const balanceSummary = document.querySelector('.balance-summary');
            const startingInput = document.getElementById('startingBalanceInput');
            const endingDisplay = document.getElementById('endingBalanceDisplay');
            
            if (!balanceSummary || !startingInput || !endingDisplay) return;
            
            // Position canvas to fill the balance summary container
            const rect = balanceSummary.getBoundingClientRect();
            canvas.style.left = '0';
            canvas.style.top = '0';
            canvas.style.width = '100%';
            canvas.style.height = '100%';
            canvas.width = rect.width;
            canvas.height = rect.height;
            
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Get positions of start and end elements relative to balance summary
            const startRect = startingInput.getBoundingClientRect();
            const endRect = endingDisplay.getBoundingClientRect();
            
            // Calculate relative positions within canvas
            // Start 100px to the right of center of starting balance input (leaving space)
            const startX = startRect.left + startRect.width / 2 - rect.left + 100;
            const startY = startRect.top + startRect.height / 2 - rect.top;
            
            // End 100px to the left of center of projected balance (leaving space)
            const endX = endRect.left + endRect.width / 2 - rect.left - 100;
            const endY = endRect.top + endRect.height / 2 - rect.top;
            
            // Control point for curve - smaller arc for better centering
            const controlX = (startX + endX) / 2;
            const controlY = Math.min(startY, endY) - 20; // 20px above for gentle arc
            
            // Draw curved line
            ctx.strokeStyle = 'rgba(139, 157, 131, 0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            ctx.quadraticCurveTo(controlX, controlY, endX, endY);
            ctx.stroke();
            
            // Draw arrowhead
            const angle = Math.atan2(endY - controlY, endX - controlX);
            const arrowLength = 12;
            ctx.fillStyle = 'rgba(139, 157, 131, 0.4)';
            ctx.beginPath();
            ctx.moveTo(endX, endY);
            ctx.lineTo(
                endX - arrowLength * Math.cos(angle - Math.PI / 6),
                endY - arrowLength * Math.sin(angle - Math.PI / 6)
            );
            ctx.lineTo(
                endX - arrowLength * Math.cos(angle + Math.PI / 6),
                endY - arrowLength * Math.sin(angle + Math.PI / 6)
            );
            ctx.closePath();
            ctx.fill();
        }

        function calculateTotals() {
            // Get starting balance from input field
            let startingBalance = window.currentStartingBalance || 0;
            const startingInput = document.getElementById('startingBalanceInput');
            if (startingInput) {
                const cleanValue = startingInput.value.replace(/[^0-9.]/g, '');
                startingBalance = parseFloat(cleanValue) || 0;
                window.currentStartingBalance = startingBalance;
            }
            
            let totalIncome = 0;
            let totalExpenses = 0;
            
            // Calculate all categories
            const allInputs = document.querySelectorAll('.expense-input');
            const categoryTotals = {};
            
            allInputs.forEach(input => {
                const category = input.getAttribute('data-category');
                const cleanValue = input.value.replace(/,/g, '');
                const value = parseFloat(cleanValue) || 0;
                
                if (!categoryTotals[category]) {
                    categoryTotals[category] = 0;
                }
                categoryTotals[category] += value;
            });
            
            // Update individual category totals and sum by type
            for (const [category, total] of Object.entries(categoryTotals)) {
                const totalElement = document.getElementById(`total_${category}`);
                if (totalElement) {
                    totalElement.innerHTML = formatCurrencyWithSuperscriptCents(total); // Changed to innerHTML with superscript
                }
                
                // Determine if this is income or expense based on data
                // We need to check the category type from the current data
                const categoryElement = document.getElementById(`${category}List`);
                if (categoryElement) {
                    // Check which section this category is in
                    const incomeSection = document.querySelector('.income-section');
                    const expenseSection = document.querySelector('.expense-section');
                    
                    if (incomeSection && incomeSection.contains(categoryElement)) {
                        totalIncome += total;
                    } else if (expenseSection && expenseSection.contains(categoryElement)) {
                        totalExpenses += total;
                    }
                }
            }

            const endingBalance = startingBalance + totalIncome - totalExpenses;

            // Calculate Available (just income) and Budgeted (Expenses)
            const available = totalIncome; // Changed: now just income, not starting balance + income
            const budgeted = totalExpenses;

            // Update main totals - show decimals with superscript for Income and Expenses totals
            document.getElementById('totalIncome').innerHTML = formatCurrencyWithSuperscriptCents(totalIncome);
            document.getElementById('totalExpenses').innerHTML = formatCurrencyWithSuperscriptCents(totalExpenses);
            
            // Use superscript cents for balance panel too
            const endingBalanceElement = document.getElementById('endingBalanceDisplay');
            endingBalanceElement.innerHTML = formatCurrencyWithSuperscriptCents(endingBalance);
            
            // Apply red color only if negative
            if (endingBalance < 0) {
                endingBalanceElement.classList.add('negative');
            } else {
                endingBalanceElement.classList.remove('negative');
            }
        }

        function makeStartingBalanceEditable() {
            const display = document.getElementById('startingBalanceDisplay');
            const input = document.getElementById('startingBalanceInput');
            
            if (!display || !input) return;
            
            const currentValue = parseFloat(input.value) || 18000;
            const newValueStr = prompt('Enter starting balance:', currentValue);
            
            if (newValueStr !== null && newValueStr !== '') {
                // Remove any non-numeric characters except decimal point
                const cleanValue = newValueStr.replace(/[^0-9.]/g, '');
                const numValue = parseFloat(cleanValue) || 0;
                
                // Update both the hidden input and display
                input.value = numValue;
                display.textContent = formatCurrency(numValue);
                window.currentStartingBalance = numValue;
                
                // Recalculate and save
                calculateTotals();
                saveBudget();
            }
        }

        async function saveBudget() {
            const budgetData = {
                income: [],
                credit: [],
                monthly: [],
                utils: [],
                oneTime: [],
                startingBalance: window.currentStartingBalance || 18000
            };

            ['income', 'credit', 'monthly', 'utils', 'oneTime'].forEach(category => {
                const list = document.getElementById(`${category}List`);
                if (list) {
                    const items = list.querySelectorAll('.expense-item');
                    items.forEach(item => {
                        const label = item.querySelector('.expense-label').textContent;
                        const input = item.querySelector('.expense-input');
                        const cleanValue = input.value.replace(/,/g, '');
                        budgetData[category].push({
                            name: label,
                            amount: parseFloat(cleanValue) || 0
                        });
                    });
                }
            });

            // Also save to localStorage as backup
            try {
                localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            } catch (e) {
                console.warn('LocalStorage save failed:', e);
            }

            if (useStorage) {
                try {
                    await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                } catch (error) {
                    // Disable persistent storage if it fails - fall back to localStorage
                    if (error.message && error.message.includes('Internal server error')) {
                        useStorage = false;
                        console.info('Using localStorage for data persistence');
                    }
                }
            }
        }

        function showAddForm(category) {
            // Try underscore format first (for custom categories)
            let formId = `add_${category}`;
            let form = document.getElementById(formId);
            
            // If not found, try capitalized format (for original categories)
            if (!form) {
                formId = `add${category.charAt(0).toUpperCase()}${category.slice(1)}`;
                form = document.getElementById(formId);
            }
            
            if (form) {
                form.classList.add('active');
            } else {
                console.error('Could not find form with id:', formId, 'for category:', category);
            }
        }

        function hideAddForm(category) {
            // Try underscore format first
            let formId = `add_${category}`;
            let nameId = `new_${category}_Name`;
            let amountId = `new_${category}_Amount`;
            
            let form = document.getElementById(formId);
            let nameInput = document.getElementById(nameId);
            let amountInput = document.getElementById(amountId);
            
            // If not found, try capitalized format
            if (!form) {
                formId = `add${category.charAt(0).toUpperCase()}${category.slice(1)}`;
                nameId = `new${category.charAt(0).toUpperCase()}${category.slice(1)}Name`;
                amountId = `new${category.charAt(0).toUpperCase()}${category.slice(1)}Amount`;
                
                form = document.getElementById(formId);
                nameInput = document.getElementById(nameId);
                amountInput = document.getElementById(amountId);
            }
            
            if (form) form.classList.remove('active');
            if (nameInput) nameInput.value = '';
            if (amountInput) amountInput.value = '';
        }

        async function addExpense(category) {
            console.log('addExpense called for category:', category);
            let nameInput, amountInput;
            
            // Try underscore format first (for all categories now)
            nameInput = document.getElementById(`new_${category}_Name`);
            amountInput = document.getElementById(`new_${category}_Amount`);
            
            // If not found, try capitalized format (fallback)
            if (!nameInput || !amountInput) {
                const capitalizedCategory = category.charAt(0).toUpperCase() + category.slice(1);
                nameInput = document.getElementById('new' + capitalizedCategory + 'Name');
                amountInput = document.getElementById('new' + capitalizedCategory + 'Amount');
            }
            
            if (!nameInput || !amountInput) {
                console.error('Could not find input fields for category:', category);
                console.error('Tried IDs: new_' + category + '_Name and new' + category.charAt(0).toUpperCase() + category.slice(1) + 'Name');
                return;
            }
            
            const name = nameInput.value.trim();
            const amount = parseFloat(amountInput.value) || 0;

            console.log('Name:', name, 'Amount:', amount);

            if (!name) {
                console.warn('Please enter an item name');
                return;
            }

            let budgetData;
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    budgetData = JSON.parse(result.value);
                } catch (error) {
                    budgetData = getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            if (!budgetData[category]) {
                budgetData[category] = [];
            }
            
            budgetData[category].push({ name, amount });
            
            console.log('Saving budget data...');
            
            if (useStorage) {
                try {
                    await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                } catch (error) {
                    console.error('Storage save error:', error);
                }
            }
            localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            
            console.log('Refreshing category display...');
            
            // Clear the form
            nameInput.value = '';
            amountInput.value = '';
            hideAddForm(category);
            
            // Refresh just the category list instead of reloading everything
            const categoryList = document.getElementById(`${category}List`);
            if (categoryList) {
                categoryList.innerHTML = renderItems(budgetData[category], category);
                
                // Re-attach event listeners to the new inputs
                categoryList.querySelectorAll('.expense-input').forEach(input => {
                    input.addEventListener('input', () => {
                        calculateTotals();
                        saveBudget();
                    });
                });
            }
            
            // Recalculate totals
            calculateTotals();
            
            // Redraw arrow after rendering
            setTimeout(drawBalanceArrow, 50);
        }

        function getCurrentBudgetData() {
            const budgetData = {
                startingBalance: window.currentStartingBalance || 18000,
                customCategories: {}
            };

            // Get all lists in the DOM and extract their data
            const allLists = document.querySelectorAll('[id$="List"]');
            
            allLists.forEach(list => {
                const categoryKey = list.id.replace('List', '');
                const items = list.querySelectorAll('.expense-item');
                
                if (items.length > 0 || categoryKey) {
                    budgetData[categoryKey] = [];
                    
                    items.forEach(item => {
                        const label = item.querySelector('.expense-label');
                        const input = item.querySelector('.expense-input');
                        if (label && input) {
                            const cleanValue = input.value.replace(/,/g, '');
                            budgetData[categoryKey].push({
                                name: label.textContent,
                                amount: parseFloat(cleanValue) || 0
                            });
                        }
                    });
                }
            });
            
            // Get customCategories metadata from the current displayed subsections
            document.querySelectorAll('.subsection').forEach(subsection => {
                const titleElement = subsection.querySelector('.subsection-name, .editable-category');
                if (titleElement) {
                    const displayName = titleElement.textContent.trim();
                    // Find the list id within this subsection
                    const listElement = subsection.querySelector('[id$="List"]');
                    if (listElement) {
                        const categoryKey = listElement.id.replace('List', '');
                        // Determine type based on parent section
                        const isIncome = subsection.closest('.income-section');
                        const type = isIncome ? 'income' : 'expense';
                        
                        budgetData.customCategories[categoryKey] = {
                            displayName: displayName,
                            type: type
                        };
                    }
                }
            });

            return budgetData;
        }

        async function showAverageTooltip(inputElement, category, itemName) {
            // Get all months' data to calculate average
            const averages = [];
            
            for (const month of allMonths) {
                if (month === currentMonth) continue; // Skip current month
                
                let monthData;
                if (useStorage) {
                    try {
                        const result = await window.storage.get(`budget:${month}`);
                        monthData = result && result.value ? JSON.parse(result.value) : null;
                    } catch (error) {
                        const localData = localStorage.getItem(`budget:${month}`);
                        monthData = localData ? JSON.parse(localData) : null;
                    }
                } else {
                    const localData = localStorage.getItem(`budget:${month}`);
                    monthData = localData ? JSON.parse(localData) : null;
                }
                
                if (monthData && monthData[category]) {
                    const matchingItem = monthData[category].find(item => item.name === itemName);
                    if (matchingItem && matchingItem.amount) {
                        averages.push(matchingItem.amount);
                    }
                }
            }
            
            if (averages.length > 0) {
                const average = averages.reduce((sum, val) => sum + val, 0) / averages.length;
                inputElement.setAttribute('title', `Average from ${averages.length} previous month${averages.length > 1 ? 's' : ''}: ${formatCurrency(average)}`);
            } else {
                inputElement.setAttribute('title', 'No previous data for this item');
            }
        }

        function hideAverageTooltip(inputElement) {
            inputElement.removeAttribute('title');
        }

        async function saveItemName(category, index, element) {
            const newName = element.textContent.trim();
            
            if (!newName) {
                // If empty, reload to restore original
                await loadMonth(currentMonth);
                return;
            }
            
            let budgetData;
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                } catch (error) {
                    const localData = localStorage.getItem(`budget:${currentMonth}`);
                    budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            if (budgetData[category] && budgetData[category][index]) {
                budgetData[category][index].name = newName;
                
                if (useStorage) {
                    try {
                        await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                    } catch (error) {
                        console.error('Error saving:', error);
                    }
                }
                localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            }
        }

        async function saveItemDate(category, index, newDate) {
            let budgetData;
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                } catch (error) {
                    const localData = localStorage.getItem(`budget:${currentMonth}`);
                    budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            if (budgetData[category] && budgetData[category][index]) {
                budgetData[category][index].date = newDate;
                
                if (useStorage) {
                    try {
                        await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                    } catch (error) {
                        console.error('Error saving:', error);
                    }
                }
                localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            }
        }

        async function saveCategoryName(categoryKey, element) {
            const newName = element.textContent.trim();
            
            console.log('saveCategoryName called:', categoryKey, 'New name:', newName);
            
            if (!newName) {
                // If empty, reload to restore original
                await loadMonth(currentMonth);
                return;
            }
            
            let budgetData;
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                } catch (error) {
                    const localData = localStorage.getItem(`budget:${currentMonth}`);
                    budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            // Ensure customCategories exists
            if (!budgetData.customCategories) {
                budgetData.customCategories = {
                    income: { displayName: 'Income Items', type: 'income' },
                    credit: { displayName: 'Credit Cards', type: 'expense' },
                    monthly: { displayName: 'Recurring Expenses', type: 'expense' },
                    utils: { displayName: 'Utilities', type: 'expense' }
                };
            }
            
            console.log('Current customCategories:', budgetData.customCategories);
            
            if (budgetData.customCategories && budgetData.customCategories[categoryKey]) {
                budgetData.customCategories[categoryKey].displayName = newName;
                
                console.log('Updated category name to:', newName);
                console.log('Updated customCategories:', budgetData.customCategories);
                
                if (useStorage) {
                    try {
                        await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                        console.log('Saved to persistent storage');
                    } catch (error) {
                        console.error('Error saving:', error);
                    }
                }
                localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
                console.log('Saved to localStorage');
                
                // Update the display name without reloading (to keep panel expanded)
                element.textContent = newName;
                
                // Update the add button text to match new category name
                const subsectionContent = element.closest('.subsection');
                if (subsectionContent) {
                    const addButton = subsectionContent.querySelector('.add-button-small');
                    if (addButton) {
                        addButton.textContent = `+ New ${newName}`;
                    }
                }
            } else {
                console.error('Category not found:', categoryKey);
            }
        }

        async function deleteItem(category, index) {
            console.log('deleteItem called:', category, index);
            
            let budgetData;
            
            if (useStorage) {
                try {
                    const result = await window.storage.get(`budget:${currentMonth}`);
                    budgetData = result && result.value ? JSON.parse(result.value) : getCurrentBudgetData();
                } catch (error) {
                    const localData = localStorage.getItem(`budget:${currentMonth}`);
                    budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
                }
            } else {
                const localData = localStorage.getItem(`budget:${currentMonth}`);
                budgetData = localData ? JSON.parse(localData) : getCurrentBudgetData();
            }
            
            console.log('Before delete:', budgetData[category]);
            
            if (budgetData[category] && budgetData[category].length > index) {
                budgetData[category].splice(index, 1);
                console.log('After delete:', budgetData[category]);
            } else {
                console.error('Category or index not found:', category, index);
                return;
            }
            
            if (useStorage) {
                try {
                    await window.storage.set(`budget:${currentMonth}`, JSON.stringify(budgetData));
                } catch (error) {
                    console.error('Error saving:', error);
                }
            }
            localStorage.setItem(`budget:${currentMonth}`, JSON.stringify(budgetData));
            
            console.log('Reloading month...');
            await loadMonth(currentMonth);
        }

        function showNewMonthModal() {
            document.getElementById('newMonthModal').classList.add('active');
        }

        function hideNewMonthModal() {
            document.getElementById('newMonthModal').classList.remove('active');
            document.getElementById('newMonthName').value = '';
        }

        function hideInfoModal() {
            document.getElementById('infoModal').classList.remove('active');
        }


        async function deleteCurrentMonth() {
            if (allMonths.length === 1) {
                alert('Cannot delete the last month');
                return;
            }

            if (confirm(`Are you sure you want to delete ${currentMonth}? This cannot be undone.`)) {
                try {
                    if (useStorage) {
                        try {
                            await window.storage.delete(`budget:${currentMonth}`);
                        } catch (storageError) {
                            console.warn('Failed to delete from persistent storage');
                        }
                    }
                    
                    // Also delete from localStorage
                    localStorage.removeItem(`budget:${currentMonth}`);
                    
                    const index = allMonths.indexOf(currentMonth);
                    allMonths.splice(index, 1);
                    
                    currentMonth = allMonths[0];
                    
                    renderMonthTabs();
                    await loadMonth(currentMonth);
                } catch (error) {
                    console.error('Error deleting month:', error);
                    alert('Error deleting month. Please try again.');
                }
            }
        }

        async function exportData() {
            try {
                const allData = {};
                
                if (useStorage) {
                    for (const month of allMonths) {
                        const result = await window.storage.get(`budget:${month}`);
                        if (result && result.value) {
                            allData[month] = JSON.parse(result.value);
                        }
                    }
                } else {
                    // Export all months from localStorage
                    // First try from allMonths array
                    for (const month of allMonths) {
                        const localData = localStorage.getItem(`budget:${month}`);
                        if (localData) {
                            allData[month] = JSON.parse(localData);
                        }
                    }
                    
                    // Fallback: scan localStorage directly for any budget: keys we might have missed
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('budget:')) {
                            const month = key.replace('budget:', '');
                            if (!allData[month]) {
                                const localData = localStorage.getItem(key);
                                if (localData) {
                                    allData[month] = JSON.parse(localData);
                                }
                            }
                        }
                    }
                }
                
                console.log('Exporting months:', Object.keys(allData));
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `budget-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                alert('Backup exported successfully!');
            } catch (error) {
                console.error('Error exporting data:', error);
                alert('Error exporting data. Please try again.');
            }
        }

        async function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('Import started, file:', file.name);
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    console.log('Parsed imported data:', Object.keys(importedData));
                    console.log('Proceeding with import (no confirmation in sidebar mode)...');
                    
                    // Proceed directly with import (confirm dialogs don't work in sidebar)
                    console.log('Starting import process...');
                    // Clear existing data from localStorage
                        for (const month of allMonths) {
                            localStorage.removeItem(`budget:${month}`);
                        }
                        
                        // Import new data to localStorage
                        for (const [month, data] of Object.entries(importedData)) {
                            localStorage.setItem(`budget:${month}`, JSON.stringify(data));
                            console.log('Imported month:', month);
                        }
                        
                        // Also try to save to persistent storage if available
                        if (useStorage) {
                            try {
                                for (const month of allMonths) {
                                    await window.storage.delete(`budget:${month}`);
                                }
                                for (const [month, data] of Object.entries(importedData)) {
                                    await window.storage.set(`budget:${month}`, JSON.stringify(data));
                                }
                            } catch (error) {
                                console.info('Persistent storage not available, using localStorage');
                            }
                        }
                        
                        // Update months list
                        allMonths = Object.keys(importedData).sort().reverse();
                        currentMonth = allMonths[0];
                        console.log('Set current month to:', currentMonth);
                        console.log('allMonths now:', allMonths);
                        
                        alert('Data imported successfully! Page will reload to show your data.');
                        
                        // Reload the page to ensure everything refreshes properly
                        window.location.reload();
                } catch (error) {
                    console.error('Error importing data:', error);
                    alert('Error importing data. Please make sure the file is a valid budget backup.');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        // Initialize app when page loads
        initApp();
        
        // Draw arrow after page fully loads
        window.addEventListener('load', () => {
            setTimeout(drawBalanceArrow, 100);
        });
        
        // Redraw arrow on window resize
        window.addEventListener('resize', drawBalanceArrow);
        
    </script>
</body>
</html>
